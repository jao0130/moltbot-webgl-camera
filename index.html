<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Moltbot Tactical Pro Cam</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root {
            --accent: #ffd60a;
            --bg: #000;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #000; color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            overflow: hidden;
            user-select: none;
        }

        #gl-canvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
            z-index: 10; pointer-events: none;
            padding: var(--safe-top) 0 var(--safe-bottom) 0;
        }

        /* È†ÇÈÉ®ÊéßÂà∂Âàó - Êì¨Áúü iOS */
        .top-bar {
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            pointer-events: auto;
        }
        .icon-circ {
            width: 32px; height: 32px; border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex; justify-content: center; align-items: center;
            font-size: 16px;
        }

        .bottom-area {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            padding-bottom: 20px;
            pointer-events: auto;
            display: flex; flex-direction: column; align-items: center;
        }

        /* Ê®°ÂºèÂàáÊèõÂô® */
        .mode-slider {
            display: flex; gap: 20px; padding: 15px 0;
            font-size: 13px; font-weight: 600; letter-spacing: 1px;
            color: #888; text-transform: uppercase;
        }
        .mode-item.active { color: var(--accent); }

        /* ÊøæÈè°ÈÅ∏ÊìáÂô® - Ê©´ÂêëÊªëÂãï */
        .vibe-nav {
            width: 100%; display: flex; gap: 15px; overflow-x: auto;
            padding: 10px 20px; scrollbar-width: none;
        }
        .vibe-nav::-webkit-scrollbar { display: none; }
        .vibe-btn {
            min-width: 70px; padding: 8px 12px; border-radius: 6px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            font-size: 11px; white-space: nowrap; color: #999; text-align: center;
        }
        .vibe-btn.active { border-color: var(--accent); color: #fff; background: rgba(255,214,10,0.1); }

        /* Âø´ÈñÄÁµÑ‰ª∂ */
        .shutter-row {
            width: 100%; display: flex; justify-content: space-around; align-items: center;
            padding: 15px 0;
        }
        .gallery-preview {
            width: 48px; height: 48px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
            background-size: cover; background-position: center; position: relative;
        }
        .burst-badge {
            position: absolute; top: -8px; right: -8px; background: var(--accent); color: #000;
            font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px;
        }
        .shutter-btn {
            width: 76px; height: 76px; border-radius: 50%; border: 4px solid #fff;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
        }
        .shutter-inner { width: 62px; height: 62px; border-radius: 50%; background: #fff; transition: 0.1s; }
        .shutter-btn:active .shutter-inner { transform: scale(0.9); }
        
        .flip-btn { width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.15); display: flex; justify-content: center; align-items: center; font-size: 22px; }

        /* ÈÅ∏ÁâáÁáàÁÆ± */
        #gallery-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: none; flex-direction: column; padding: var(--safe-top) 15px var(--safe-bottom) 15px;
        }
        .gallery-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; }
        .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; overflow-y: auto; flex-grow: 1; padding: 15px 0; }
        .gallery-item { position: relative; border-radius: 12px; overflow: hidden; border: 2px solid transparent; }
        .gallery-item.selected { border-color: var(--accent); }
        .gallery-item img { width: 100%; display: block; }
        .gallery-footer { display: flex; gap: 10px; padding: 20px 0; }
        .action-btn { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 14px; }

        #flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 1000; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <video id="video" style="display:none" autoplay playsinline muted></video>
    <canvas id="gl-canvas"></canvas>
    <div id="flash"></div>

    <div id="ui-layer">
        <div class="top-bar">
            <div class="icon-circ">‚ö°</div>
            <div style="font-size: 12px; font-weight: bold; letter-spacing: 1px;">PRO VIDEO</div>
            <div class="icon-circ" onclick="clearBurst()">C</div>
        </div>

        <div class="bottom-area">
            <div class="vibe-nav" id="vibe-nav"></div>
            
            <div class="mode-slider">
                <div class="mode-item">ÂΩ±Áâá</div>
                <div class="mode-item active">ÁÖßÁâá</div>
                <div class="mode-item">‰∫∫ÂÉè</div>
            </div>

            <div class="shutter-row">
                <div class="gallery-preview" id="gallery-trigger" onclick="openGallery()" style="visibility: hidden;">
                    <div class="burst-badge" id="burst-count">0</div>
                </div>
                <div class="shutter-btn" onclick="handleShutter()">
                    <div class="shutter-inner"></div>
                </div>
                <div class="flip-btn" onclick="toggleCamera()">üîÑ</div>
            </div>
        </div>
    </div>

    <div id="gallery-overlay">
        <div class="gallery-header">
            <h3 style="margin:0">Êà∞Ë°ìÈÅ∏Áâá</h3>
            <div onclick="closeGallery()" style="color: var(--accent); font-weight:600">ÂèñÊ∂à</div>
        </div>
        <div class="gallery-grid" id="gallery-grid"></div>
        <div class="gallery-footer">
            <button class="action-btn" style="background:#222; color:#fff" onclick="clearBurst()">Êç®Ê£Ñ</button>
            <button class="action-btn" style="background:var(--accent); color:#000" onclick="saveSelected()">ÂÑ≤Â≠òÊâÄÈÅ∏</button>
        </div>
    </div>

<script id="vs" type="x-shader/x-vertex">
    attribute vec2 position;
    varying vec2 vTexCoord;
    uniform bool uMirror;
    uniform vec2 uTexScale;
    void main() {
        float x = uMirror ? -position.x : position.x;
        vTexCoord = vec2(x * 0.5 + 0.5, 1.0 - (position.y * 0.5 + 0.5));
        vTexCoord = (vTexCoord - 0.5) * uTexScale + 0.5;
        gl_Position = vec4(position, 0.0, 1.0);
    }
</script>

<script id="fs" type="x-shader/x-fragment">
    precision highp float;
    varying vec2 vTexCoord;
    uniform sampler2D uSampler;
    uniform vec2 uResolution;
    
    // Ê≥®ÂÖ•ÂèÉÊï∏
    uniform float uExposure;
    uniform float uBrilliance;
    uniform float uHighlights;
    uniform float uShadows;
    uniform float uContrast;
    uniform float uBrightness;
    uniform float uBlackPoint;
    uniform float uSaturation;
    uniform float uVibrance;
    uniform float uTemperature;
    uniform float uTint;
    uniform float uSharpness;
    uniform float uVignette;

    void main() {
        if (vTexCoord.x < 0.0 || vTexCoord.x > 1.0 || vTexCoord.y < 0.0 || vTexCoord.y > 1.0) {
            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0); return;
        }

        vec2 pixelSize = 1.0 / uResolution;
        vec4 center = texture2D(uSampler, vTexCoord);
        
        // 1. Sharpness (Convolution)
        if (uSharpness > 0.0) {
            vec4 n = texture2D(uSampler, vTexCoord + vec2(0.0, pixelSize.y));
            vec4 s = texture2D(uSampler, vTexCoord - vec2(0.0, pixelSize.y));
            vec4 e = texture2D(uSampler, vTexCoord + vec2(pixelSize.x, 0.0));
            vec4 w = texture2D(uSampler, vTexCoord - vec2(pixelSize.x, 0.0));
            center = center + uSharpness * (center * 4.0 - n - s - e - w);
        }

        vec3 color = center.rgb;

        // 2. Exposure & Brightness
        color *= pow(2.0, uExposure);
        color += uBrightness;

        // 3. Black Point
        color = max(vec3(0.0), color - uBlackPoint) / (1.0 - uBlackPoint);

        // 4. Highlights & Shadows
        float luma = dot(color, vec3(0.299, 0.587, 0.114));
        if (luma < 0.4) color += color * uShadows * ((0.4 - luma) / 0.4);
        if (luma > 0.6) color += color * uHighlights * ((luma - 0.6) / 0.4);

        // 5. Contrast & Brilliance
        color = mix(color, pow(color, vec3(1.0 - uBrilliance * 0.4)), 0.5);
        color = (color - 0.5) * (1.0 + uContrast) + 0.5;

        // 6. Saturation & Vibrance
        float gray = dot(color, vec3(0.299, 0.587, 0.114));
        float maxColor = max(color.r, max(color.g, color.b));
        float minColor = min(color.r, min(color.g, color.b));
        float sat = (maxColor - minColor) / (maxColor + 0.001);
        color = mix(vec3(gray), color, 1.0 + uSaturation + uVibrance * (1.0 - sat));

        // 7. Temperature & Tint
        color.r += uTemperature * 0.1;
        color.b -= uTemperature * 0.1;
        color.g += uTint * 0.05;

        // 8. Vignette
        vec2 dist = (vTexCoord - 0.5) * 2.0;
        float vign = 1.0 - dot(dist, dist) * uVignette;
        color *= clamp(vign, 0.0, 1.0);

        gl_FragColor = vec4(clamp(color, 0.0, 1.0), 1.0);
    }
</script>

<script>
    const canvas = document.getElementById('gl-canvas');
    const gl = canvas.getContext('webgl', { preserveDrawingBuffer: true });
    const video = document.getElementById('video');
    const flash = document.getElementById('flash');
    const burstCountLabel = document.getElementById('burst-count');
    const galleryOverlay = document.getElementById('gallery-overlay');
    const galleryGrid = document.getElementById('gallery-grid');
    const galleryTrigger = document.getElementById('gallery-trigger');

    let program, texture;
    let currentFacingMode = 'environment';
    let isMirrored = false;
    let burstPhotos = [];
    let shouldCapture = false;
    let lastClickTime = 0;

    const presets = [
        { name: "ÂéüÂúñ", p: { exposure: 0, brilliance: 0, highlights: 0, shadows: 0, contrast: 0, brightness: 0, blackPoint: 0, saturation: 0, vibrance: 0, temp: 0, tint: 0, sharpness: 0, vignette: 0 } },
        { 
            name: "CCD", 
            p: { exposure: -0.30, brilliance: -0.06, highlights: 0.15, shadows: 0.10, contrast: 0.08, brightness: 0.32, blackPoint: -0.06, saturation: 0.04, vibrance: 0, temp: -0.08, tint: 0, sharpness: 0.50, vignette: 0 } 
        },
        { 
            name: "ÊüØÈÅîÂ∫ïÁâá", 
            p: { exposure: 0, brilliance: -0.16, highlights: -0.10, shadows: -0.30, contrast: -0.05, brightness: 0.06, blackPoint: 0.30, saturation: 0.10, vibrance: -0.45, temp: 0.50, tint: -0.16, sharpness: 0.08, vignette: 0 } 
        },
        { 
            name: "ÂØåÂ£´Â∫ïÁâá", 
            p: { exposure: -0.05, brilliance: -0.08, highlights: 0.15, shadows: -0.12, contrast: 0, brightness: 0, blackPoint: 0, saturation: 0, vibrance: -0.06, temp: -0.10, tint: 0, sharpness: 0, vignette: 0.15 } 
        },
        { 
            name: "Êó•ËêΩËâ≤Ë™ø", 
            p: { exposure: 0.30, brilliance: 0.35, highlights: -0.30, shadows: 0.20, contrast: 0.25, brightness: 0, blackPoint: 0.15, saturation: 0.10, vibrance: 0.20, temp: 0.3, tint: 0, sharpness: 0.15, vignette: 0 } 
        },
        { 
            name: "ÈõªÂΩ±Ëâ≤ÂΩ©", 
            p: { exposure: -0.35, brilliance: -0.30, highlights: -0.30, shadows: 0.30, contrast: 0.15, blackPoint: -0.20, saturation: 0, vibrance: 0.10, temp: 0.15, tint: 0.10, sharpness: 0.10, vignette: 0 } 
        }
    ];

    let activePreset = presets[0];

    async function initCamera() {
        if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: currentFacingMode, width: { ideal: 3840 }, height: { ideal: 2160 } }
            });
            video.srcObject = stream;
            await video.play();
            isMirrored = (currentFacingMode === 'user');
            resize();
        } catch (err) { alert(err.message); }
    }

    function initWebGL() {
        const vs = gl.createShader(gl.VERTEX_SHADER);
        gl.shaderSource(vs, document.getElementById('vs').text);
        gl.compileShader(vs);
        const fs = gl.createShader(gl.FRAGMENT_SHADER);
        gl.shaderSource(fs, document.getElementById('fs').text);
        gl.compileShader(fs);
        program = gl.createProgram();
        gl.attachShader(program, vs); gl.attachShader(program, fs);
        gl.linkProgram(program); gl.useProgram(program);

        const posBuf = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, posBuf);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, 1,1]), gl.STATIC_DRAW);
        const posLoc = gl.getAttribLocation(program, 'position');
        gl.enableVertexAttribArray(posLoc);
        gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);

        texture = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
    }

    function resize() {
        canvas.width = window.innerWidth * window.devicePixelRatio;
        canvas.height = window.innerHeight * window.devicePixelRatio;
        gl.viewport(0, 0, canvas.width, canvas.height);
    }

    function render() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            gl.bindTexture(gl.TEXTURE_2D, texture);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, video);
            
            const vAspect = video.videoWidth / video.videoHeight;
            const cAspect = canvas.width / canvas.height;
            let sx = 1, sy = 1;
            if (vAspect > cAspect) sx = cAspect / vAspect; else sy = vAspect / cAspect;

            gl.uniform1i(gl.getUniformLocation(program, 'uMirror'), isMirrored);
            gl.uniform2f(gl.getUniformLocation(program, 'uTexScale'), sx, sy);
            gl.uniform2f(gl.getUniformLocation(program, 'uResolution'), canvas.width, canvas.height);
            
            const p = activePreset.p;
            for (let key in p) {
                gl.uniform1f(gl.getUniformLocation(program, `u${key.charAt(0).toUpperCase() + key.slice(1)}`), p[key]);
            }

            gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
            if (shouldCapture) { captureFrame(); shouldCapture = false; }
        }
        requestAnimationFrame(render);
    }

    function handleShutter() {
        if (burstPhotos.length >= 10) return;
        flash.style.opacity = '1';
        setTimeout(() => flash.style.opacity = '0', 60);
        shouldCapture = true;
    }

    function captureFrame() {
        canvas.toBlob(blob => {
            burstPhotos.push(blob);
            updateBurstUI();
        }, 'image/jpeg', 1.0);
    }

    function updateBurstUI() {
        const count = burstPhotos.length;
        burstCountLabel.textContent = count;
        if (count > 0) {
            galleryTrigger.style.visibility = 'visible';
            galleryTrigger.style.backgroundImage = `url(${URL.createObjectURL(burstPhotos[count-1])})`;
        } else {
            galleryTrigger.style.visibility = 'hidden';
        }
    }

    function renderPresets() {
        const nav = document.getElementById('vibe-nav');
        presets.forEach(item => {
            const btn = document.createElement('div');
            btn.className = 'vibe-btn' + (item.name === activePreset.name ? ' active' : '');
            btn.textContent = item.name;
            btn.onclick = () => {
                activePreset = item;
                document.querySelectorAll('.vibe-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };
            nav.appendChild(btn);
        });
    }

    function openGallery() {
        galleryGrid.innerHTML = '';
        burstPhotos.forEach((blob, i) => {
            const item = document.createElement('div');
            item.className = 'gallery-item selected';
            item.innerHTML = `<img src="${URL.createObjectURL(blob)}">`;
            galleryGrid.appendChild(item);
        });
        galleryOverlay.style.display = 'flex';
    }

    async function saveSelected() {
        for (let blob of burstPhotos) {
            const file = new File([blob], `Shot_${Date.now()}.jpg`, { type: 'image/jpeg' });
            if (navigator.share) await navigator.share({ files: [file] });
        }
        clearBurst(); closeGallery();
    }

    function clearBurst() { burstPhotos = []; updateBurstUI(); closeGallery(); }
    function closeGallery() { galleryOverlay.style.display = 'none'; }
    function toggleCamera() { currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment'; initCamera(); }

    // ÈõôÊìäÁï´Èù¢ÁøªËΩâÈè°È†≠
    document.addEventListener('touchstart', (e) => {
        const now = Date.now();
        if (now - lastClickTime < 300) toggleCamera();
        lastClickTime = now;
    });

    window.addEventListener('resize', resize);
    renderPresets(); initWebGL(); initCamera(); requestAnimationFrame(render);
</script>
</body>
</html>
